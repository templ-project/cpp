############################################################################
# Tools Configuration                                                      #
############################################################################

[tools]

# ==========================================================================
# Compilers
# ==========================================================================

# TODO: Github Backend still has issues with asset_pattern matching for LLVM releases -> mise bug
# https://github.com/llvm/llvm-project/releases
#
[tools."http:llvm/llvm-project"]
version = "20.1.8"

# TODO: Need a Linux distro to test this
# TODO: Need a Windows distro to test this
[tools."http:llvm/llvm-project".platforms]
linux-x64 = { url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-{version}/LLVM-{version}-Linux-X64.tar.xz" }
macos-arm64 = { url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-{version}/LLVM-{version}-macOS-ARM64.tar.xz" }
windows-x64 = { url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-{version}/LLVM-{version}-win64.exe" }

# ==========================================================================
# Build Tools
# ==========================================================================

# https://github.com/bazelbuild/bazel
#
[tools."github:bazelbuild/bazel"]
version = "8"
bin = "bazel"

# TODO: Need a Linux distro to test this
# TODO: Need a Windows distro to test this
[tools."github:bazelbuild/bazel".platforms]
linux-x64 = { asset_pattern = "bazel-*-linux-88_x64" }
macos-arm64 = { asset_pattern = "bazel-*-darwin-arm64" }
windows-x64 = { asset_pattern = "bazel-*-windows-x86_64.exe", bin = "bazel.exe" }

# https://github.com/Kitware/CMake/releases
#
[tools."github:Kitware/CMake"]
version = "latest"

# TODO: Need a Linux distro to test this
[tools."github:Kitware/CMake".platforms]
linux-x64 = { asset_pattern = "cmake-*-linux-x86_64.tar.gz" }
macos-arm64 = { asset_pattern = "cmake-*-macos-universal.tar.gz", bin_path = "CMake.app/Contents/bin" }
windows-x64 = { asset_pattern = "cmake-*-windows-x86_64.zip" }

# https://github.com/xmake-io/xmake/releases
#
[tools."github:xmake-io/xmake"]
# TODO: Latest (3.0.4) has issues with some lua modules -> pin to 3.0.3 for now
version = "3.0.3"
bin = "xmake"

# TODO: Need a Linux distro to test this
[tools."github:xmake-io/xmake".platforms]
linux-x64 = { asset_pattern = "xmake-bundle-v*.linux.x64" }
macos-arm64 = { asset_pattern = "xmake-bundle-v*.macos.arm64" }
windows-x64 = { asset_pattern = "xmake-bundle-v*.win64.exe", bin = "xmake.exe" }

# ==========================================================================
# Other Tools
# ==========================================================================

# Node.js for jscpd
#
[tools.node]
version = "latest"

# Python and package manager
#
[tools.python]
version = "3.11" # Will install 3.11 or above based on availability
[tools.uv]
version = "latest"

# TODO: Need to install manually; so far no registry nor backends support
# # Debugger
# [tools.gdb]
# version = "latest"

# TODO: Need to install manually; so far no registry nor backends support
# Memory profiler (Linux/macOS only)
# [tools.valgrind]
# version = "latest"

############################################################################
# Environment variables                                                    #
############################################################################

# Environment variables
[env]
_.python.venv = { path = ".venv", create = true } # Auto-create venv
SDKROOT = "{% if os() == 'macos' %}/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk{% else %}{{env.SDKROOT}}{% endif %}"
CFLAGS = "{% if os() == 'macos' %}-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk{% else %}{{env.CFLAGS}}{% endif %}"
CXXFLAGS = "{% if os() == 'macos' %}-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk{% else %}{{env.CXXFLAGS}}{% endif %}"
LDFLAGS = "{% if os() == 'macos' %}-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -L/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib{% else %}{{env.LDFLAGS}}{% endif %}"

############################################################################
# Task definitions.                                                        #
############################################################################

# ==========================================================================
# Build Tasks
# ==========================================================================

[tasks.build]
description = "Build Project"
# outputs = []
run = '''
    mise run build:${usage_build_system?}
'''
sources = [
    "src/**/*.cpp",
    "src/**/*.hpp",
    "include/**/*.hpp",
    "include/**/*.h",
    "tests/**/*.cpp"
]
usage = '''
flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (bazel, cmake, xmake)" default="cmake"
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

[tasks."build:bazel"]
description = "Build Project Using Bazel"
outputs = [ "bazel-bin/${usage_project_name?}" ]
run = '''
BAZEL_CONFIG=""
if [ "${usage_build_type?}" = "Debug" ]; then
    BAZEL_CONFIG="--compilation_mode=dbg"
else
    BAZEL_CONFIG="--compilation_mode=opt"
fi

bazel build //:${usage_project_name?} $BAZEL_CONFIG

# Generate compile_commands.json for IDE integration
if command -v bazel-compdb >/dev/null 2>&1; then
    bazel-compdb
fi
'''
sources = [ "BUILD", "WORKSPACE", ".bazelrc" ]
usage = '''
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

[tasks."build:cmake"]
description = "Build Project Using CMake"
outputs = [ "${usage_build_dir?}/CMakeCache.txt", "${usage_build_dir?}/compile_commands.json" ]
run = '''
CMAKE_VARS=""
if [ "${usage_build_type?}" = "Debug" ]; then
    CMAKE_VARS='-DCMAKE_CXX_FLAGS=--coverage'
fi

cmake -B "${usage_build_dir}" -G "Unix Makefiles" \
    -DCMAKE_BUILD_TYPE="${usage_build_type}" \
    -DCMAKE_CXX_COMPILER="${usage_compiler}" \
    $CMAKE_VARS \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

cmake --build "${usage_build_dir}" --parallel
'''
sources = [ "CMakeLists.txt", "tests/CMakeLists.txt" ]
usage = '''
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

[tasks."build:xmake"]
description = "Build Project Using XMake"
outputs = [ ".xmake/cache/config", "${usage_build_dir}/compile_commands.json" ]
run = '''
XMAKE_ARGS=""
if [ "${usage_build_type?}" = "Debug" ]; then
    XMAKE_ARGS='--cxflags="--coverage" --ldflags="--coverage"'
fi
xmake f -m $(echo "${usage_build_type}" | tr '[:upper:]' '[:lower:]') \
    $XMAKE_ARGS \
    --toolchain=clang -y

xmake build
xmake project -k compile_commands "${usage_build_dir}"
'''
sources = [ "xmake.lua" ]
usage = '''
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

# ============================================================================
# Clean Tasks
# ============================================================================

[tasks.clean]
description = "Clean all build artifacts"
run = """
rm -rf \
    ~/.local/state/mise/task-sources/* \
    .cache \
    .coverage \
    .jscpd/html \
    .task \
    .xmake \
    ${usage_build_dir} \
    bazel-* \
    docs-html \
    node_modules \
    package-lock.json
"""
usage = '''
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
'''

# ============================================================================
# Test Tasks
# ============================================================================

[tasks.test]
description = "Run tests"
run = '''
mise run build:${usage_build_system?} --build-type Debug --build-dir ${usage_build_dir?} --compiler ${usage_compiler?} --project-name ${usage_project_name?}
mise run test:${usage_build_system?} --build-dir ${usage_build_dir?} --project-name ${usage_project_name?} --cov-tool ${usage_cov_tool?}
'''
usage = '''
flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (bazel, cmake, xmake)" default="cmake"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
flag "-c --cov-tool <name>" env="CPP_COV_TOOL" help="Coverage tool to use (gcovr, lcov, gcov, llvm-cov)" default="gcovr"
'''

[tasks."test:bazel"]
description = "Run tests with coverage using Bazel"
hide = true
run = '''
BAZEL_CONFIG=""
if [ "${usage_cov_tool?}" = "gcovr" ] || [ "${usage_cov_tool?}" = "lcov" ]; then
    BAZEL_CONFIG="--config=coverage"
fi

bazel test //tests:${usage_project_name?}-tests $BAZEL_CONFIG --test_output=all

# Generate coverage if configured
if [ -n "$BAZEL_CONFIG" ]; then
    bazel coverage //tests:${usage_project_name?}-tests $BAZEL_CONFIG
    mise run test:gen-coverage --cov-tool ${usage_cov_tool?} --build-dir bazel-out
fi
'''
usage = '''
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
flag "-c --cov-tool <name>" env="CPP_COV_TOOL" help="Coverage tool to use (gcovr, lcov, gcov, llvm-cov)" default="gcovr"
'''

[tasks."test:cmake"]
description = "Run tests with coverage using CMake"
hide = true
run = [
    "cd ${usage_build_dir} && ctest --output-on-failure",
    "mise run test:gen-coverage --cov-tool ${usage_cov_tool?} --build-dir ${usage_build_dir?}"
]
usage = '''
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
flag "-c --cov-tool <name>" env="CPP_COV_TOOL" help="Coverage tool to use (gcovr, lcov, gcov, llvm-cov)" default="gcovr"
'''

[tasks."test:xmake"]
description = "Run tests with coverage using XMake"
hide = true
run = [
    "xmake run ${usage_project_name?}-tests",
    "mise run test:gen-coverage --cov-tool ${usage_cov_tool?} --build-dir ${usage_build_dir?}"
]
usage = '''
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
flag "-c --cov-tool <name>" env="CPP_COV_TOOL" help="Coverage tool to use (gcovr, lcov, gcov, llvm-cov)" default="gcovr"
'''

[tasks."test:gen-coverage"]
description = "Generate coverage report (CLI table + optional HTML) (requires gcovr/gcov/llvm-cov)"
hide = true
run = '''
echo "üìä Generating coverage report..."
echo ""

case "${usage_cov_tool}" in
  gcovr)
    if ! command -v gcovr >/dev/null 2>&1; then
      echo "‚ö†Ô∏è gcovr not found. Install: uv pip install gcovr"
      exit 1
    fi
    mkdir -p .coverage
    gcovr --root . \
      --filter 'src/.*' --filter 'include/.*' \
      --exclude 'tests/.*' --exclude 'build/_deps/.*' \
      --gcov-ignore-errors=no_working_dir_found \
      --txt --html-details .coverage/index.html 2>/dev/null
    echo ""
    echo "üìÑ HTML report: .coverage/index.html"
    ;;

  lcov)
    if ! command -v lcov >/dev/null 2>&1 || ! command -v genhtml >/dev/null 2>&1; then
      echo "‚ö†Ô∏è lcov/genhtml not found. Install via package manager."
      exit 1
    fi
    mkdir -p .coverage
    lcov --capture --directory "${usage_build_dir}" \
      --output-file .coverage/coverage.info \
      --rc lcov_branch_coverage=1 2>/dev/null
    lcov --remove .coverage/coverage.info '/usr/*' '*/tests/*' '*/build/_deps/*' \
      --output-file .coverage/coverage.info 2>/dev/null
    lcov --list .coverage/coverage.info
    genhtml .coverage/coverage.info \
      --output-directory .coverage \
      --branch-coverage --quiet
    echo "üìÑ HTML report: .coverage/index.html"
    ;;

  gcov|llvm-cov)
    if command -v llvm-cov >/dev/null 2>&1; then
      find "${usage_build_dir}" -name "*.gcno" -exec llvm-cov gcov {} \; 2>/dev/null
      echo "üìÅ .gcov files generated in build directory"
    elif command -v gcov >/dev/null 2>&1; then
      find "${usage_build_dir}" -name "*.gcno" -exec gcov {} \; 2>/dev/null
      echo "üìÅ .gcov files generated in build directory"
    else
      echo "‚ö†Ô∏è Neither llvm-cov nor gcov found"
      exit 1
    fi
    ;;

  *)
    echo "‚ùå Unknown coverage tool: ${usage_cov_tool}"
    echo "Available: gcovr, lcov, gcov, llvm-cov"
    exit 1
    ;;
esac
'''
usage = '''
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --cov-tool <name>" env="CPP_COV_TOOL" help="Coverage tool to use (gcovr, lcov, gcov, llvm-cov)" default="gcovr"
'''

# TODO: Test Watch still needs work
# [tasks."test:watch"]
# description = "Run tests in watch mode"
# run = """
# echo "üîÑ Watch mode: Waiting for file changes..."
# echo "üí° Tip: Install 'entr' for automatic re-running:"
# echo "    find src tests -name '*.cpp' -o -name '*.hpp' | entr -c mise run test"
# mise run test
# """
# usage = '''
# flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (cmake, xmake)" default="cmake"
# flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
# flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
# flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
# flag "-c --cov-tool <name>" env="CPP_COV_TOOL" help="Coverage tool to use (gcovr, lcov, gcov, llvm-cov)" default="gcovr"
# '''

# ============================================================================
# Code Quality Tasks
# ============================================================================

[tasks.format]
description = "Format code and fix issues"
run = """
SCRIPT_ARGS=""
if [ "${usage_staged}" = "true" ]; then
    SCRIPT_ARGS="$SCRIPT_ARGS --staged"
fi
if [ "${usage_fix}" = "true" ]; then
    SCRIPT_ARGS="$SCRIPT_ARGS --fix"
fi
python scripts/format.py $SCRIPT_ARGS
"""
usage = '''
flag "-i --fix" help="Automatically fix formatting issues"
flag "-s --staged" help="Only check/format staged files in git"
'''

[tasks.lint]
description = "Run linter and fix issues"
run = '''
mise run build:${usage_build_system?} --build-type=${usage_build_type?} --build-dir=${usage_build_dir?} \
    --compiler=${usage_compiler?} --project-name=${usage_project_name?}

set -ex
SCRIPT_ARGS=""
if [ "${usage_staged}" = "true" ]; then
    SCRIPT_ARGS="$SCRIPT_ARGS --staged"
fi
if [ "${usage_fix}" = "true" ]; then
    SCRIPT_ARGS="$SCRIPT_ARGS --fix"
fi
python scripts/lint.py --build-dir ${usage_build_dir} $SCRIPT_ARGS
'''
usage = '''
flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (bazel, cmake, xmake)" default="cmake"
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
flag "-i --fix" help="Automatically fix formatting issues"
flag "-s --staged" help="Only check/format staged files in git"
'''

[tasks."duplicate-check"]
description = "Check for duplicate code using jscpd"
run = """
[ ! -d ./node_modules ] && npm install jscpd @jscpd/badge-reporter
npx jscpd src/ include/
git add .jscpd/jscpd-badge.svg 2>/dev/null || true
"""

# ============================================================================
# Development Tools
# ============================================================================

[tasks.run]
description = "Run application with debugger (requires gdb)"
run = """
mise run build:${usage_build_system?} --build-type=${usage_build_type?} --build-dir=${usage_build_dir?} \
    --compiler=${usage_compiler?} --project-name=${usage_project_name?}

if [ "${usage_build_system?}" = "bazel" ]; then
    bazel run //:${usage_project_name?}
else
    ./${usage_build_dir?}/**/${usage_project_name?}
fi
"""
usage = '''
flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (bazel, cmake, xmake)" default="cmake"
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

[tasks.debug]
description = "Run application with debugger (requires gdb)"
run = """
mise run build:${usage_build_system?} --build-type=Debug --build-dir=${usage_build_dir?} \
    --compiler=${usage_compiler?} --project-name=${usage_project_name?}

if command -v gdb >/dev/null 2>&1; then
  if [ "${usage_build_system?}" = "bazel" ]; then
    gdb bazel-bin/${usage_project_name?}
  else
    gdb ./${usage_build_dir}/**/${usage_project_name?}
  fi
else
  echo "‚ùå gdb not found. Please install gdb first."
  exit 1
fi
"""
usage = '''
flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (bazel, cmake, xmake)" default="cmake"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

# [tasks.valgrind]
# description = "Run application with Valgrind (requires valgrind)"
# depends = ["build:debug"]
# run = """
# if command -v valgrind >/dev/null 2>&1; then
#   valgrind --leak-check=full --show-leak-kinds=all ./${usage_build_dir}/src/${usage_project_name?}
# else
#   echo "‚ùå valgrind not found. Please install valgrind first."
#   exit 1
# fi
# """

# ============================================================================
# Documentation Tasks
# ============================================================================

[tasks.docs]
description = "Build documentation"
run = "mkdocs build"

[tasks."docs:serve"]
description = "Serve documentation locally with live reload"
run = """
echo "üìö Starting documentation server..."
echo "üìñ Open http://127.0.0.1:8000 in your browser"
mkdocs serve
"""

[tasks."docs:deploy"]
description = "Deploy documentation to GitHub Pages"
run = "mkdocs gh-deploy --force"

# ============================================================================
# Validation Tasks
# ============================================================================

[tasks.validate]
description = "Run integration tests"
run = """
for build_system in bazel cmake xmake; do
    echo "#==================================================================="
    echo "# Validating build system: $build_system"
    echo "#==================================================================="
    mise run validate:by:build-system --build-system $build_system \
        --build-type ${usage_build_type?} --build-dir ${usage_build_dir?} \
        --compiler ${usage_compiler?} --project-name ${usage_project_name?}
done
"""
usage = '''
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''

[tasks."validate:by:build-system"]
description = "Run CI pipeline (format, lint, duplicate-check, test)"
hide = true
run = """
mise run clean

mise run format --fix

mise run duplicate-check

mise run lint --build-system ${usage_build_system?} --build-type ${usage_build_type?} \
    --build-dir ${usage_build_dir?} --compiler ${usage_compiler?} --project-name ${usage_project_name?} \
    --fix

mise run test --build-system ${usage_build_system?} \
    --build-dir ${usage_build_dir?} --compiler ${usage_compiler?} --project-name ${usage_project_name?}

mise run clean

mise run build --build-system ${usage_build_system?} --build-type ${usage_build_type?} \
    --build-dir ${usage_build_dir?} --compiler ${usage_compiler?} --project-name ${usage_project_name?}

echo ""
echo "üèÉ Running integration test for ${usage_build_system?}..."
if [ "${usage_build_system?}" = "bazel" ]; then
    ./bazel-bin/${usage_project_name?}
else
    find ./${usage_build_dir?} -name ${usage_project_name?} {% if os() == 'macos' %}-perm +755{% else %}-executable{% endif %} -type f -exec {} \\;
fi

echo ""
echo "‚úì Integration test passed for ${usage_build_system?}!"
echo ""
echo ""
"""
usage = '''
flag "-s --build-system <system>" env="CPP_BUILD_SYSTEM" help="Build system to use (bazel, cmake, xmake)" default="cmake"
flag "-t --build-type <type>" env="CPP_BUILD_TYPE" help="Build type (Release, Debug)" default="Release"
flag "-d --build-dir <dir>" env="CPP_BUILD_DIR" help="Build directory" default="build"
flag "-c --compiler <compiler>" env="CPP_COMPILER" help="C++ compiler to use" default="clang++"
flag "-p --project-name <name>" env="CPP_PROJECT_NAME" help="Project name" default="cpp-template"
'''
