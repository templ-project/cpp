version: "3"

vars:
  CPP_PROJECT_NAME: '{{default .CPP_PROJECT_NAME "cpp-template"}}'
  CPP_BUILD_SYSTEM: '{{default .CPP_BUILD_SYSTEM "cmake"}}'
  CPP_BUILD_DIR: '{{default .CPP_BUILD_DIR "build"}}'
  CPP_BUILD_TYPE: '{{default .CPP_BUILD_TYPE "Release"}}'
  CPP_COMPILER: '{{default .CPP_COMPILER "clang++"}}'
  CPP_COV_TOOL: '{{default .CPP_COV_TOOL "gcovr"}}'

tasks:
  # ==========================================================================
  # Build Tasks
  # ==========================================================================

  build:
    desc: "Build project (system: {{.CPP_BUILD_SYSTEM}}, type: {{.CPP_BUILD_TYPE}})"
    cmds:
      - task: "build:{{.CPP_BUILD_SYSTEM}}"
        vars:
          CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
    sources:
      - src/**/*.cpp
      - src/**/*.hpp
      - include/**/*.hpp
      - include/**/*.h
      - tests/**/*.cpp

  build:bazel:
    desc: "Build project using Bazel"
    sources:
      - BUILD.bazel
      - tests/BUILD.bazel
      - .bazelrc
      - MODULE.bazel
      - WORKSPACE
    generates:
      - bazel-bin/{{.CPP_PROJECT_NAME}}
    env:
      CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
      CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      CPP_COMPILER: "{{.CPP_COMPILER}}"
      CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - python scripts/compile_templates.py --build-system bazel --compiler {{.CPP_COMPILER}}
      - |
        BAZEL_CONFIG=""
        if [ "{{.CPP_BUILD_TYPE}}" = "Debug" ]; then
            BAZEL_CONFIG="--compilation_mode=dbg"
        else
            BAZEL_CONFIG="--compilation_mode=opt"
        fi
        bazel build //:{{.CPP_PROJECT_NAME}} $BAZEL_CONFIG

        # Generate compile_commands.json for clang-tidy using Hedron
        bazel run @hedron_compile_commands//:refresh_all

  build:cmake:
    desc: "Build project using CMake"
    sources:
      - CMakeLists.txt
      - tests/CMakeLists.txt
    generates:
      - "{{.CPP_BUILD_DIR}}/CMakeCache.txt"
      - "{{.CPP_BUILD_DIR}}/compile_commands.json"
    env:
      CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
      CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      CPP_COMPILER: "{{.CPP_COMPILER}}"
      CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - python scripts/compile_templates.py --build-system cmake --compiler {{.CPP_COMPILER}}
      - |
        CMAKE_VARS=""
        if [ "{{.CPP_BUILD_TYPE}}" = "Debug" ]; then
            CMAKE_VARS='-DCMAKE_CXX_FLAGS=--coverage'
        fi
        cmake -B "{{.CPP_BUILD_DIR}}" -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE="{{.CPP_BUILD_TYPE}}" \
            -DCMAKE_CXX_COMPILER="{{.CPP_COMPILER}}" \
            $CMAKE_VARS \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        cmake --build "{{.CPP_BUILD_DIR}}" --parallel

  build:xmake:
    desc: "Build project using XMake"
    sources:
      - xmake.lua
    generates:
      - .xmake/cache/config
      - "{{.CPP_BUILD_DIR}}/compile_commands.json"
    env:
      CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
      CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      CPP_COMPILER: "{{.CPP_COMPILER}}"
      CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - python scripts/compile_templates.py --build-system xmake --compiler {{.CPP_COMPILER}}
      - |
        XMAKE_ARGS=""
        if [ "{{.CPP_BUILD_TYPE}}" = "Debug" ]; then
            XMAKE_ARGS='--cxflags="--coverage" --ldflags="--coverage"'
        fi
        xmake f -m $(echo "{{.CPP_BUILD_TYPE}}" | tr '[:upper:]' '[:lower:]') \
            $XMAKE_ARGS \
            --toolchain=clang -y
        xmake build
        xmake project -k compile_commands "{{.CPP_BUILD_DIR}}"

  # ============================================================================
  # Clean Tasks
  # ============================================================================

  clean:
    desc: "Clean all build artifacts"
    cmds:
      - |
        rm -rf \
            .bazelrc \
            .cache \
            .coverage \
            .jscpd/html \
            .task \
            .xmake \
            {{.CPP_BUILD_DIR}} \
            BUILD.bazel \
            tests/BUILD.bazel \
            CMakeLists.txt \
            MODULE.bazel \
            WORKSPACE \
            bazel-* \
            compile_commands.json \
            docs-html \
            node_modules \
            package-lock.json \
            xmake.lua

  # docs:
  #   desc: "Generate documentation with Doxygen"
  #   deps:
  #     - task: which
  #       vars:
  #         COMMAND: "doxygen"
  #   cmds:
  #     - doxygen Doxyfile

  # duplicate-check:
  #   desc: "Check for duplicate code using jscpd"
  #   deps:
  #     - task: which
  #       vars:
  #         COMMAND: "node"
  #   cmds:
  #     - cmd: |
  #         [ ! -d ./node_modules ] && npm install jscpd  @jscpd/badge-reporter

  #         mise exec -- npx jscpd src/ include/

  #         git add .jscpd/jscpd-badge.svg 2>/dev/null || true

  # ============================================================================
  # Code Quality Tasks
  # ============================================================================

  format:
    desc: "Format code and fix issues"
    cmds:
      - |
        SCRIPT_ARGS="--fix"
        python scripts/format.py $SCRIPT_ARGS

  format:check:
    desc: "Check code formatting without fixing"
    cmds:
      - python scripts/format.py

  lint:
    desc: "Run linter and fix issues"
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
    cmds:
      - |
        # Bazel generates compile_commands.json at project root, others use build dir
        LINT_BUILD_DIR="{{.CPP_BUILD_DIR}}"
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            LINT_BUILD_DIR="."
        fi
        python scripts/lint.py --build-dir "$LINT_BUILD_DIR" --fix

  lint:check:
    desc: "Run linter without fixing"
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
    cmds:
      - |
        # Bazel generates compile_commands.json at project root, others use build dir
        LINT_BUILD_DIR="{{.CPP_BUILD_DIR}}"
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            LINT_BUILD_DIR="."
        fi
        python scripts/lint.py --build-dir "$LINT_BUILD_DIR"

  duplicate-check:
    desc: "Check for duplicate code using jscpd"
    cmds:
      - "[ ! -d ./node_modules ] && npm install jscpd @jscpd/badge-reporter"
      - npx jscpd src/ include/
      - git add .jscpd/jscpd-badge.svg 2>/dev/null || true

  # ============================================================================
  # Test Tasks
  # ============================================================================

  test:
    desc: "Run tests (system: {{.CPP_BUILD_SYSTEM}})"
    vars:
      TEST_BUILD_TYPE: Debug
    cmds:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_TYPE: 'Debug'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
      - task: test:{{.CPP_BUILD_SYSTEM}}
        vars:
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
          CPP_COV_TOOL: '{{.CPP_COV_TOOL}}'

  test:bazel:
    desc: "Run tests with Bazel (coverage not supported - use cmake/xmake)"
    cmds:
      - |
        # Note: Bazel's coverage system doesn't work reliably with Clang on macOS
        # For coverage reports, use cmake or xmake build systems instead
        bazel test //tests:{{.CPP_PROJECT_NAME}}-tests --test_output=all

        echo ""
        echo "‚ÑπÔ∏è  Note: Bazel coverage is not supported with Clang on macOS"
        echo "üí° For coverage reports, run: task test CPP_BUILD_SYSTEM=cmake"
        echo ""

  test:cmake:
    desc: "Run tests with coverage using CMake"
    cmds:
      - cd {{.CPP_BUILD_DIR}} && ctest --output-on-failure
      - task: test:gen-coverage
        vars:
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COV_TOOL: '{{.CPP_COV_TOOL}}'

  test:xmake:
    desc: "Run tests with coverage using XMake"
    cmds:
      - xmake run {{.CPP_PROJECT_NAME}}-tests
      - task: test:gen-coverage
        vars:
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COV_TOOL: '{{.CPP_COV_TOOL}}'

  test:gen-coverage:
    desc: "Generate coverage report"
    cmds:
      - |
        echo "üìä Generating coverage report..."
        echo ""
        case "{{.CPP_COV_TOOL}}" in
          gcovr)
            if ! command -v gcovr >/dev/null 2>&1; then
              echo "‚ö†Ô∏è gcovr not found. Install: uv pip install gcovr"
              exit 1
            fi
            mkdir -p .coverage
            gcovr --root . \
              --filter 'src/.*' --filter 'include/.*' \
              --exclude 'tests/.*' --exclude 'build/_deps/.*' \
              --gcov-ignore-errors=no_working_dir_found \
              --txt --html-details .coverage/index.html 2>/dev/null
            echo "ÔøΩ HTML report: .coverage/index.html"
            ;;
          lcov)
            if ! command -v lcov >/dev/null 2>&1 || ! command -v genhtml >/dev/null 2>&1; then
              echo "‚ö†Ô∏è lcov/genhtml not found."
              exit 1
            fi
            mkdir -p .coverage
            lcov --capture --directory "{{.CPP_BUILD_DIR}}" \
              --output-file .coverage/coverage.info \
              --rc lcov_branch_coverage=1 2>/dev/null
            lcov --remove .coverage/coverage.info '/usr/*' '*/tests/*' '*/build/_deps/*' \
              --output-file .coverage/coverage.info 2>/dev/null
            lcov --list .coverage/coverage.info
            genhtml .coverage/coverage.info \
              --output-directory .coverage \
              --branch-coverage --quiet
            echo "üìÑ HTML report: .coverage/index.html"
            ;;
          *)
            echo "‚ùå Unknown coverage tool: {{.CPP_COV_TOOL}}"
            exit 1
            ;;
        esac

  # ============================================================================
  # Development Tools
  # ============================================================================

  run:
    desc: "Run application"
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
    cmds:
      - |
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            bazel run //:{{.CPP_PROJECT_NAME}}
        else
            ./{{.CPP_BUILD_DIR}}/**/{{.CPP_PROJECT_NAME}}
        fi

  debug:
    desc: "Run application with debugger (requires gdb)"
    vars:
      DEBUG_BUILD_TYPE: Debug
    cmds:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_TYPE: "{{.DEBUG_BUILD_TYPE}}"
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
      - |
        if ! command -v gdb >/dev/null 2>&1; then
          echo "‚ùå gdb not found. Please install gdb first."
          exit 1
        fi
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            gdb bazel-bin/{{.CPP_PROJECT_NAME}}
        else
            gdb ./{{.CPP_BUILD_DIR}}/**/{{.CPP_PROJECT_NAME}}
        fi

  # ============================================================================
  # Documentation Tasks
  # ============================================================================

  docs:
    desc: "Build documentation"
    cmds:
      - mkdocs build

  docs:serve:
    desc: "Serve documentation locally with live reload"
    cmds:
      - |
        echo "üìö Starting documentation server..."
        echo "üìñ Open http://127.0.0.1:8000 in your browser"
        mkdocs serve

  docs:deploy:
    desc: "Deploy documentation to GitHub Pages"
    cmds:
      - mkdocs gh-deploy --force

  # ============================================================================
  # Validation Tasks
  # ============================================================================

  validate:
    desc: "Run integration tests for all build systems"
    cmds:
      - for:
          - bazel
          - cmake
          - xmake
        task: validate:by:build-system
        vars:
          CPP_BUILD_SYSTEM: "{{.ITEM}}"
          CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
          CPP_COV_TOOL: '{{.CPP_COV_TOOL}}'

  validate:by:build-system:
    desc: "Run CI pipeline for specific build system"
    cmds:
      - task: clean
        vars:
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
      - task: format
      - task: duplicate-check
      - task: lint
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
      - task: clean
        vars:
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
      - task: test
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
          CPP_COV_TOOL: '{{.CPP_COV_TOOL}}'
      - task: clean
        vars:
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
      - |
        echo ""
        echo "üèÉ Running integration test for {{.CPP_BUILD_SYSTEM}}..."
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            ./bazel-bin/{{.CPP_PROJECT_NAME}}
        else
            find ./{{.CPP_BUILD_DIR}} -name {{.CPP_PROJECT_NAME}} -perm +755 -type f -exec {} \;
        fi
        echo ""
        echo "‚úì Integration test passed for {{.CPP_BUILD_SYSTEM}}!"
        echo ""
        echo ""

  # ============================================================================
  # Python/UV Package Management Tasks
  # ============================================================================

  uv:refresh:
    desc: "Refresh all Python packages (update dependencies)"
    cmds:
      - |
        echo "üîÑ Refreshing Python packages..."
        uv sync --upgrade
        echo "‚úì Packages refreshed"

  uv:sync:
    desc: "Install Python dependencies (including pre-commit)"
    cmds:
      - |
        echo "üì¶ Installing Python dependencies..."
        uv sync
        echo "ü™ù Installing pre-commit hooks..."
        pre-commit install
        echo "‚úì Python environment ready"

  # valgrind:
  #   desc: "Run application with Valgrind"
  #   deps:
  #     - task: which
  #       vars:
  #         COMMAND: "valgrind"
  #     - task: build
  #       vars: { CPP_BUILD_TYPE: "Debug" }
  #   cmds:
  #     - mise exec -- valgrind --leak-check=full --show-leak-kinds=all ./{{.CPP_BUILD_DIR}}/src/{{.CPP_PROJECT_NAME}}
