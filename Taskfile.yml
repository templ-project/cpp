version: '3'

vars:
  # mise dependent
  __TF_MISE_E: 'mise trust; mise exec --'
  __TF_MISE_E_UV_RUN: 'mise trust; mise exec -- uv run'
  # os dependent
  __TF_COMMAND_WRAPPER:
    sh: |
      echo '{{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command{{else}}bash -c{{end}}'
  __TF_VAR_PREFIX:
    sh: |
      echo "{{if eq OS "windows"}}\${{else}}{{end}}"
  __TF_HEADER_LINE: '=============================================================='
  __TF_SEP: ' '

  # cpp project defaults
  __TF_VALIDATION_CPP_BUILD_SYSTEMS:
    sh: |
      echo "bazel cmake xmake"
  __TF_VALIDATION__CPP_COMPILERS:
    sh: |
      echo "clang++ {{if eq OS "windows"}}msvc{{else}}g++{{end}}"
  CPP_PROJECT_NAME: '{{default .CPP_PROJECT_NAME "cpp-template"}}'
  CPP_BUILD_SYSTEM: '{{default .CPP_BUILD_SYSTEM "cmake"}}' # bazel, cmake, xmake
  CPP_BUILD_DIR: '{{default .CPP_BUILD_DIR "build"}}'
  CPP_BUILD_TYPE: '{{default .CPP_BUILD_TYPE "Release"}}'
  CPP_COMPILER: '{{default .CPP_COMPILER "clang++"}}' # clang++, g++, msvc (windows)

env:
  BAZEL_VC:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "(Get-ChildItem 'C:\Program Files*\Microsoft Visual Studio\*\*\VC\Tools\MSVC' | Sort-Object LastWriteTime -Descending | Select-Object -First 1).Parent.Parent.FullName"{{else}}echo ""{{end}}
  BAZEL_VC_FULL_VERSION:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "(Get-ChildItem 'C:\Program Files*\Microsoft Visual Studio\*\*\VC\Tools\MSVC\*' | Sort-Object LastWriteTime -Descending | Select-Object -First 1).Name"{{else}}echo ""{{end}}
  BAZEL_LLVM:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "try { (Get-Item (Get-Command clang++).Source).Directory.Parent.FullName } catch { echo '' }"{{else}}echo ""{{end}}
  CMAKE_VS_GENERATOR:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "(Get-ChildItem 'C:\Program Files*\Microsoft Visual Studio\*' -Directory | Sort-Object Name | Select-Object -First 1).Name | ForEach-Object { if (\$_ -eq '2022') { 'Visual Studio 17 2022' } elseif (\$_ -eq '2019') { 'Visual Studio 16 2019' } elseif (\$_ -eq '2017') { 'Visual Studio 15 2017' } else { 'Visual Studio 17 2022' } }"{{else}}echo ""{{end}}
  # LLVM_ROOT:
  #   sh: |
  #     {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command '(Get-Item (Get-Command clang++).Source).Directory.Parent.FullName'{{else}}dirname $(dirname $(which clang++)){{end}}
  SDKROOT:
    sh: |
      echo "{{if eq OS "darwin"}}/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk{{else}}$SDKROOT{{end}}"
  # LDFLAGS:
  #   sh: |
  #     {{if eq OS "darwin"}}echo "-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk -L/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib"{{else if eq OS "linux"}}echo ""{{else}}LLVM_ROOT=$(powershell -ExecutionPolicy Bypass -Command '(Get-Item (Get-Command clang++).Source).Directory.Parent.FullName'); echo "-L\"$LLVM_ROOT/lib\""{{end}}

tasks:
  # ==========================================================================
  # Build Tasks
  # ==========================================================================

  print:env:
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} env | sort
        platforms: [darwin, linux]
      - cmd: |
          {{.__TF_MISE_E}} {{ .__TF_SEP
            }}pwsh -Command '$BashPath=(Get-Command bash -ErrorAction SilentlyContinue).Path;{{ .__TF_SEP
              }}if ($BashPath) { & $BashPath -c "env | sort" }{{ .__TF_SEP
              }}else { Get-ChildItem "Env:" | Sort-Object Name | ForEach-Object { "$($_.Name)=$($_.Value)" } }'
        platforms: [windows]
    desc: 'Print current build environment variables'

  build:
    desc: 'Build project (system: {{.CPP_BUILD_SYSTEM}}, type: {{.CPP_BUILD_TYPE}})'
    cmds:
      - cmd: |
          echo "{{.__TF_HEADER_LINE}}"
          echo "Compiling for {{OS}}/{{ARCH}}, using {{.CPP_BUILD_SYSTEM}} and {{.CPP_COMPILER}}"
          echo "{{.__TF_HEADER_LINE}}"
          {{if ne OS "windows"}}{{if eq .CPP_COMPILER "msvc"}}
            echo "‚ùå MSVC compiler is only supported on Windows."
            exit 1
          {{end}}{{end}}
      - task: print:env
      - task: 'build:{{.CPP_BUILD_SYSTEM}}'
        vars:
          CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
    sources:
      - src/**/*.cpp
      - src/**/*.hpp
      - include/**/*.hpp
      - include/**/*.h
      - tests/**/*.cpp

  build:bazel:
    desc: 'Build project using Bazel'
    deps:
      - deps:sync:uv
    sources:
      - BUILD.bazel
      - tests/BUILD.bazel
      - .bazelrc
      - MODULE.bazel
      - WORKSPACE
    generates:
      - bazel-bin/{{.CPP_PROJECT_NAME}}
    env:
      CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
      CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
      CPP_COMPILER: '{{.CPP_COMPILER}}'
      CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} python .scripts/compile_templates.py --build-system bazel --compiler {{.CPP_COMPILER}}
      - |
        BAZEL_CONFIG="{{if eq .CPP_BUILD_TYPE "Debug"}}--compilation_mode=dbg{{else}}--compilation_mode=opt{{end}}"
        {{.__TF_MISE_E}} bazel build //:{{.CPP_PROJECT_NAME}} $BAZEL_CONFIG

        # Generate compile_commands.json for clang-tidy using Hedron
        {{if ne .CPP_COMPILER "msvc"}}
        {{.__TF_MISE_E}} bazel run @hedron_compile_commands//:refresh_all
        {{end}}

  build:cmake:
    desc: 'Build project using CMake'
    sources:
      - CMakeLists.txt
      - tests/CMakeLists.txt
    generates:
      - '{{.CPP_BUILD_DIR}}/CMakeCache.txt'
      - '{{.CPP_BUILD_DIR}}/compile_commands.json'
    env:
      CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
      CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
      CPP_COMPILER: '{{.CPP_COMPILER}}'
      CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
    vars:
      CMAKE_GENERATOR: '{{if eq OS "windows"}}{{if eq .CPP_COMPILER "msvc"}}{{.CMAKE_VS_GENERATOR}}{{else}}Ninja{{end}}{{else}}Unix Makefiles{{end}}'
      CMAKE_COMPILER_FLAG: '{{if eq .CPP_COMPILER "msvc"}}{{else}}-DCMAKE_CXX_COMPILER={{.CPP_COMPILER}}{{end}}'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} python .scripts/compile_templates.py --build-system cmake --compiler {{.CPP_COMPILER}}
      - |
        {{.__TF_MISE_E_UV_RUN}} cmake -B "{{.CPP_BUILD_DIR}}" -G "{{.CMAKE_GENERATOR}}" \
            -DCMAKE_BUILD_TYPE="{{.CPP_BUILD_TYPE}}" \
            {{.CMAKE_COMPILER_FLAG}} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        {{.__TF_MISE_E_UV_RUN}} cmake --build "{{.CPP_BUILD_DIR}}" --parallel

  build:xmake:
    desc: 'Build project using XMake'
    sources:
      - xmake.lua
    generates:
      - .xmake/cache/config
      - '{{.CPP_BUILD_DIR}}/compile_commands.json'
    env:
      CPP_BUILD_TYPE: '{{.CPP_BUILD_TYPE}}'
      CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
      CPP_COMPILER: '{{.CPP_COMPILER}}'
      CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
      '{{if and (eq OS "windows") (eq .CPP_COMPILER "clang++")}}CXXFLAGS': '-Wno-error -Wno-unknown-warning-option'
    vars:
      XMAKE_MODE: '{{if eq .CPP_BUILD_TYPE "Debug"}}debug{{else}}release{{end}}'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} python .scripts/compile_templates.py --build-system xmake --compiler {{.CPP_COMPILER}}
      - |
        {{.__TF_MISE_E}} xmake f -m {{.XMAKE_MODE}} -y
        {{.__TF_MISE_E}} xmake build -y
        {{.__TF_MISE_E}} xmake project -k compile_commands "{{.CPP_BUILD_DIR}}"

  # ============================================================================
  # Clean Tasks
  # ============================================================================

  clean:
    desc: 'Clean all build artifacts'
    cmds:
      - |
        rm -rf \
            .bazelrc \
            .cache \
            .jscpd/html \
            .task \
            .xmake \
            {{.CPP_BUILD_DIR}} \
            BUILD.bazel \
            CMakeLists.txt \
            compile_commands.json \
            coverage \
            docs-html \
            MODULE.bazel \
            src/CMakeLists.txt \
            tests/BUILD.bazel \
            WORKSPACE \
            xmake.lua

        find . -type d -name "bazel-*" | while read d; do rm -rf "$d"; done

        rm -rf ~/AppData/Local/Temp/.xmake*

  # ============================================================================
  # Code Quality Tasks
  # ============================================================================

  format:
    desc: 'Format code and fix issues'
    cmds:
      - task: format:prettier
      - task: format:clang
      - cmd: echo "‚úÖ Code format completed"

  format:clang:
    cmds:
      - |
        {{.__TF_MISE_E}} python .scripts/format-clang.py --fix
    desc: 'Format code using clang-format'
    silent: true

  format:prettier:
    cmds:
      - |
        {{.__TF_MISE_E}} npx prettier --write "./**/*.{json,toml,yaml,yml}"
    desc: 'Format code using Prettier'
    silent: true

  format:check:
    cmds:
      - task: format:check:prettier
      - task: format:check:clang
      - cmd: echo "‚úÖ Code format check completed"
    desc: 'Check code formatting without fixing'

  format:check:prettier:
    cmds:
      - |
        {{.__TF_MISE_E}} npx prettier --check "./**/*.{json,toml,yaml,yml}"
    desc: 'Check code formatting using Prettier'
    silent: true

  format:check:clang:
    cmds:
      - |
        {{.__TF_MISE_E}} python .scripts/format-clang.py --check
    desc: 'Check code formatting using clang-format'
    silent: true

  lint:
    desc: 'Run linter and fix issues'
    cmds:
      - task: lint:eslint
      - task: lint:powershell
      - task: lint:shellcheck
      - task: lint:clang
      - cmd: echo "‚úÖ Linting completed"

  lint:staged:
    desc: 'Run linter on staged files and fix issues'
    cmds:
      - |
        {{.__TF_MISE_E}} npx -y lint-staged
    silent: true

  lint:eslint:
    cmds:
      - |
        {{.__TF_MISE_E}} npx eslint --fix "./**/*.{json,toml,yaml,yml}"
      - echo "- ‚úÖ eslint lint completed"
    desc: 'Lint code using ESLint'
    silent: true

  lint:clang:
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} python .scripts/lint-clang.py --fix
      - echo "- ‚úÖ clang lint completed"
    desc: 'Lint code and fix issues'
    silent: true

  lint:powershell:
    aliases: [lint:pwsh]
    cmds:
      - |
        {{.__TF_MISE_E}} pwsh -NoProfile -File .scripts/lint-powershell.ps1 -Fix {{if .STAGED}}-Staged{{end}}
      - echo "- ‚úÖ pwsh lint completed"
    desc: 'Lint PowerShell scripts using PSScriptAnalyzer'
    silent: true

  lint:shellcheck:
    aliases: [lint:sh, lint:bash]
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} bash .scripts/lint-shellcheck.sh --fix {{if .STAGED}}--staged{{end}}
        platforms: [darwin, linux]
      - cmd: |
          {{.__TF_MISE_E}} pwsh -NoProfile -File .scripts/lint-shellcheck.ps1 -Fix {{if .STAGED}}-Staged{{end}}
        platforms: [windows]
      - echo "- ‚úÖ bash lint completed"
    desc: 'Lint shell scripts using ShellCheck'
    silent: true

  lint:check:
    desc: 'Run linter without fixing'
    cmds:
      - task: lint:check:eslint
      - task: lint:check:clang
      - task: lint:check:powershell
      - task: lint:check:shellcheck
      - cmd: echo "‚úÖ Linting check completed"

  lint:check:eslint:
    cmds:
      - |
        {{.__TF_MISE_E}} npx eslint "./**/*.{toml,json,yaml,yml}"
      - echo "- ‚úÖ eslint lint check completed"
    desc: 'Check config files using eslint'
    silent: true

  lint:check:clang:
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} python .scripts/lint-clang.py
      - echo "- ‚úÖ clang lint check completed"
    desc: 'Check C++ scripts using clang-tidy'
    silent: true

  lint:check:powershell:
    aliases: [lint:check:pwsh]
    cmds:
      - |
        {{.__TF_MISE_E}} pwsh -NoProfile -File .scripts/lint-powershell.ps1 {{if .STAGED}}-Staged{{end}}
      - echo "- ‚úÖ pwsh lint completed"
    desc: 'Check PowerShell scripts using PSScriptAnalyzer'
    silent: true

  lint:check:shellcheck:
    aliases: [lint:check:sh, lint:check:bash]
    cmds:
      - cmd: |
          {{.__TF_MISE_E}} bash .scripts/lint-shellcheck.sh {{if .STAGED}}--staged{{end}}
        platforms: [darwin, linux]
      - cmd: |
          {{.__TF_MISE_E}} pwsh -NoProfile -File .scripts/lint-shellcheck.ps1 {{if .STAGED}}-Staged{{end}}
        platforms: [windows]
      - echo "- ‚úÖ bash lint completed"
    desc: 'Check shell scripts using ShellCheck'
    silent: true

  duplicate-check:
    desc: 'Check for duplicate code using jscpd'
    cmds:
      - |
        {{.__TF_MISE_E}} npx jscpd src/ include/
      - git add .jscpd/jscpd-badge.svg 2>/dev/null || true

  # ============================================================================
  # Test Tasks
  # ============================================================================

  test:
    desc: 'Run tests (system: {{.CPP_BUILD_SYSTEM}})'
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_TYPE: Debug
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
    cmds:
      - task: test:{{.CPP_BUILD_SYSTEM}}
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
    silent: true

  test:bazel:
    desc: 'Run tests with Bazel'
    cmds:
      - cmd: |
          {{if eq OS "linux"}}
            {{if eq .CPP_COMPILER "g++"}}
          echo "üìä Running tests with coverage for g++..."
          {{.__TF_MISE_E}} bazel coverage //tests/... --config=coverage --nocache_test_results
            {{else}}
          echo "‚úÖ Running tests (coverage only supported with g++)..."
          {{.__TF_MISE_E}} bazel test //tests/... --test_output=errors
            {{end}}
          {{else}}
          echo "‚úÖ Running tests (coverage only supported on Linux with g++)..."
          {{.__TF_MISE_E}} bazel test //tests/... --test_output=errors
          {{end}}
        platforms: [darwin, linux]
      - cmd: |
          {{.__TF_MISE_E}} bazel test //tests/... --test_output=errors
        platforms: [windows]
      - task: test:gen-coverage
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
      - echo "- ‚úÖ tests completed"
    silent: true

  test:cmake:
    desc: 'Run tests with CMake'
    cmds:
      - |
        cd {{.CPP_BUILD_DIR}} && {{.__TF_MISE_E_UV_RUN}} ctest --output-on-failure {{if eq .CPP_COMPILER "msvc"}}-C Debug{{end}}
      - task: test:gen-coverage
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
      - echo "- ‚úÖ tests completed"
    silent: true

  test:xmake:
    desc: 'Run tests with XMake'
    vars:
      XMAKE_MODE: '{{if eq .CPP_BUILD_TYPE "Debug"}}debug{{else}}release{{end}}'
    cmds:
      - |
        {{.__TF_MISE_E}} xmake run -y {{.CPP_PROJECT_NAME}}-tests
      - task: test:gen-coverage
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}/{{.XMAKE_MODE}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
      - echo "- ‚úÖ tests completed"
    silent: true

  test:gen-coverage:
    desc: 'Generate coverage report'
    cmds:
      - cmd: |
          {{if eq .CPP_COMPILER "msvc"}}
          echo "‚ö†Ô∏è Coverage generation is not supported with MSVC. Skipping."
          exit 0
          {{end}}
        platforms: [windows]
      - cmd: |
          {{if eq .CPP_BUILD_SYSTEM "bazel"}}
            {{if or (ne .CPP_COMPILER "g++") (ne OS "linux")}}
          echo "‚ö†Ô∏è Bazel coverage is only supported with g++ on Linux. Skipping."
          exit 0
            {{end}}

          if [ ! -f "bazel-out/_coverage/_coverage_report.dat" ]; then
            echo "‚ö†Ô∏è No coverage data found. Did coverage run successfully?"
            exit 0
          fi

          if ! command -v genhtml >/dev/null 2>&1; then
            echo "‚ö†Ô∏è genhtml not found. Install: sudo apt-get install lcov"
            exit 1
          fi

          echo "üìä Coverage Summary (Source Files Only):"
          if command -v lcov >/dev/null 2>&1; then
            lcov --list bazel-out/_coverage/_coverage_report.dat 2>/dev/null | \
              tail -n +3 | \
              grep -v -E "(tests/|integration/|unit/)" | \
              grep -v "^Executed" | \
              grep -v "^Test cases" || \
              lcov --list bazel-out/_coverage/_coverage_report.dat 2>/dev/null | tail -n +3
          fi

          mkdir -p coverage
          if ! genhtml bazel-out/_coverage/_coverage_report.dat \
            --output-directory coverage \
            --branch-coverage \
            --highlight \
            --legend \
            --ignore-errors empty \
            --quiet 2>/dev/null; then
            echo "‚ö†Ô∏è Failed to generate coverage report. The coverage data may be empty."
            exit 0
          fi

          echo "‚úÖ HTML coverage report: coverage/index.html"
          exit 0
          {{end}}
        platforms: [darwin, linux]
      - cmd: |
          {{if or (eq .CPP_BUILD_SYSTEM "cmake") (eq .CPP_BUILD_SYSTEM "xmake")}}
            {{if eq .CPP_COMPILER "msvc"}}
          echo "‚ö†Ô∏è Coverage is not supported with MSVC. Skipping."
          exit 0
            {{end}}

          echo "üìä Generating coverage report..."

          GCOV_EXEC="gcov"
          {{if eq .CPP_COMPILER "clang++"}}
          if command -v llvm-cov >/dev/null 2>&1; then
            GCOV_EXEC="llvm-cov gcov"
            echo "‚ÑπÔ∏è Using llvm-cov for clang++ coverage"
          else
            echo "‚ö†Ô∏è Warning: llvm-cov not found, coverage may fail with clang++"
          fi
          {{else if eq .CPP_COMPILER "g++"}}
          CXX_VERSION=$({{.CPP_COMPILER}} -dumpversion | cut -d. -f1)
          if command -v "gcov-$CXX_VERSION" >/dev/null 2>&1; then
            GCOV_EXEC="gcov-$CXX_VERSION"
            echo "‚ÑπÔ∏è Using $GCOV_EXEC to match {{.CPP_COMPILER}} version $CXX_VERSION"
          else
            echo "‚ö†Ô∏è Warning: gcov-$CXX_VERSION not found, using default gcov"
          fi
          {{end}}

          {{.__TF_MISE_E_UV_RUN}} gcovr --root . \
            --filter 'src/.*' --filter 'include/.*' \
            --exclude 'tests/.*' --exclude 'build/_deps/.*' \
            --gcov-executable "$GCOV_EXEC" \
            --gcov-ignore-errors=no_working_dir_found \
            --txt

          mkdir -p coverage
          {{.__TF_MISE_E_UV_RUN}} gcovr --root . \
            --filter 'src/.*' --filter 'include/.*' \
            --exclude 'tests/.*' --exclude 'build/_deps/.*' \
            --gcov-executable "$GCOV_EXEC" \
            --gcov-ignore-errors=no_working_dir_found \
            --html-details coverage/index.html 2>/dev/null
          echo "‚úÖ HTML coverage report: coverage/index.html"
          {{end}}
        platforms: [darwin, linux]
      - cmd: |
          {{if or (eq .CPP_BUILD_SYSTEM "cmake") (eq .CPP_BUILD_SYSTEM "xmake")}}
            {{if eq .CPP_COMPILER "msvc"}}
          echo "‚ö†Ô∏è Coverage is not supported with MSVC. Skipping."
          exit 0
            {{end}}
          {{end}}
        platforms: [windows]
    silent: true

  # ============================================================================
  # Development Tools
  # ============================================================================

  run:
    desc: 'Run application'
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_PROJECT_NAME: '{{.CPP_PROJECT_NAME}}'
    cmds:
      - |
        echo "üèÉ Running application..."
        {{.__TF_COMMAND_WRAPPER}} '{{
          .__TF_VAR_PREFIX}}BUILD_PATH="{{if eq .CPP_BUILD_SYSTEM "bazel"}}bazel-out{{else}}{{.CPP_BUILD_DIR}}{{end}}";{{.__TF_SEP}}{{
            if ne OS "windows"}}eval $(find ./$BUILD_PATH/{{if eq .CPP_BUILD_SYSTEM "bazel"}}*-opt{{end}} -type f -name {{.CPP_PROJECT_NAME}} | head -n 1){{
            else}}(Get-ChildItem ./$BUILD_PATH{{if eq .CPP_BUILD_SYSTEM "bazel"}}/*-opt/bin{{end}} -Recurse -Filter {{
              .CPP_PROJECT_NAME}}.exe | Select-Object -First 1).FullName | ForEach-Object { & $_ }{{
            end}}'

  debug:
    desc: 'Run application with debugger (gdb on Linux/macOS)'
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: '{{.CPP_BUILD_SYSTEM}}'
          CPP_BUILD_TYPE: Debug
          CPP_BUILD_DIR: '{{.CPP_BUILD_DIR}}'
          CPP_COMPILER: '{{.CPP_COMPILER}}'
    cmds:
      - cmd: |
          {{if eq OS "windows"}}
          echo "‚ö†Ô∏è CLI debugging not supported on Windows."
          echo "‚ÑπÔ∏è Please use Visual Studio or your IDE's debugger instead."
          echo ""
          echo "Alternatively, install gdb via MSYS2 and run manually:"
          {{.__TF_COMMAND_WRAPPER}} '{{
            .__TF_VAR_PREFIX}}BUILD_PATH="{{if eq .CPP_BUILD_SYSTEM "bazel"}}bazel-out{{else}}{{.CPP_BUILD_DIR}}{{end}}";{{.__TF_SEP}}{{
              }}(Get-ChildItem ./$BUILD_PATH{{if eq .CPP_BUILD_SYSTEM "bazel"}}/*-dbg/bin{{end}} -Recurse -Filter {{
                .CPP_PROJECT_NAME}}.exe | Select-Object -First 1).FullName | ForEach-Object { Write-Host "gdb `"$_`"" }'
          exit 0
          {{else}}
          if ! command -v gdb >/dev/null 2>&1; then
            echo "‚ö†Ô∏è gdb not found. Please install gdb first."
            exit 1
          fi
          echo "üêõ Starting gdb debugger..."
          gdb $(find ./{{if eq .CPP_BUILD_SYSTEM "bazel"}}bazel-out/*-dbg{{else}}{{.CPP_BUILD_DIR}}{{end}} -name {{.CPP_PROJECT_NAME}} | head -n 1)
          {{end}}

  # ============================================================================
  # Documentation Tasks
  # ============================================================================

  docs:
    desc: 'Build documentation'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} mkdocs build

  docs:serve:
    desc: 'Serve documentation locally with live reload'
    cmds:
      - |
        echo "üìö Starting documentation server..."
        echo "üìñ Open http://127.0.0.1:8000 in your browser"
        {{.__TF_MISE_E_UV_RUN}} mkdocs serve

  docs:deploy:
    desc: 'Deploy documentation to GitHub Pages'
    cmds:
      - |
        {{.__TF_MISE_E_UV_RUN}} mkdocs gh-deploy --force

  # ============================================================================
  # Validation Tasks
  # ============================================================================

  validate:
    cmds:
      - cmd: |
          {{range $build := .__TF_VALIDATION_CPP_BUILD_SYSTEMS | splitList " "}}
            task validate:by:build-system CPP_BUILD_SYSTEM="{{$build}}"
          {{end}}
    desc: 'Run integration tests for all build systems'
    silent: true

  validate:by:build-system:
    cmds:
      - cmd: |
          bs='{{.CPP_BUILD_SYSTEM}}'
          hl="{{.__TF_HEADER_LINE}}"
          {{range $compiler := .__TF_VALIDATION__CPP_COMPILERS | splitList " "}}
            echo $hl
            echo "üèÉ Running validation for $bs with {{$compiler}}..."
            echo $hl
            echo ""
            task validate:by:build-system:compiler \
              CPP_PROJECT_NAME="cpp-template" \
              CPP_BUILD_SYSTEM="$bs" \
              CPP_COMPILER="{{$compiler}}" \
              CPP_BUILD_DIR="build"
          {{end}}
    desc: 'Run CI pipeline for specific build system'
    silent: true

  validate:by:build-system:compiler:
    cmds:
      - task: format
      - task: clean
      - task: build
      - task: lint
      - task: run
      - task: clean
      - task: test
      # - task: docs
      - cmd: |
          echo ""
          echo "{{.__TF_HEADER_LINE}}"
          echo "‚úÖ Validation successful for {{.CPP_BUILD_SYSTEM}} with {{.CPP_COMPILER}}"
          echo "{{.__TF_HEADER_LINE}}"
          echo ""
    desc: 'Run CI pipeline for specific build system and compiler'
    silent: true

  # ============================================================================
  # Dependencies
  # ============================================================================

  deps:clean:
    cmds:
      - task: deps:clean:mise
      - task: deps:clean:npm
      - task: deps:clean:uv
    desc: 'Clean all project dependencies'

  deps:clean:mise:
    cmds:
      - echo "üßπ Cleaning Mise dependencies..."
      - cmd: rm -rf ~/.local/share/mise/installs
        platforms: [darwin, linux]
      - cmd: powershell -File 'Remove-Item -Recurse -Force $env:LOCALAPPDATA\mise\installs'
        platforms: [windows]
      - echo "‚úì Mise environment cleaned"
    desc: 'Clean Mise dependencies'

  deps:clean:npm:
    cmds:
      - |
        echo "üßπ Cleaning NodeJs dependencies..."
        rm -rf node_modules package-lock.json
        echo "‚úì NodeJs environment cleaned"
    desc: 'Clean NodeJs dependencies'

  deps:clean:uv:
    cmds:
      - |
        echo "üßπ Cleaning Python dependencies..."
        rm -rf .venv uv.lock
        echo "‚úì Python environment cleaned"
    desc: 'Clean Python dependencies'

  deps:sync:
    cmds:
      - task: deps:sync:mise
      - task: deps:sync:npm
      - task: deps:sync:uv
    desc: 'Install all project dependencies'

  deps:sync:mise:
    cmds:
      - |
        echo "üì¶ Installing Mise dependencies..."
        if [ ! -f .mise.local.lock ] && [ ! -f .mise.lock ]; then
          echo "‚ö†Ô∏è  .mise.local.lock not found; sync won't generate .mise.lock automatically."
          echo "Please create a .mise.local.lock file or a .mise.lock file to proceed."
          echo ""
          echo "[settings]"
          echo "experimental = true"
          echo "lockfile = true"
          echo ""
          exit 1
        fi
        mise trust && mise install --yes
        echo "‚úì Mise environment ready"
    desc: 'Install Mise dependencies'

  deps:sync:npm:
    cmds:
      - |
        echo "üì¶ Installing NodeJs dependencies..."
        {{.__TF_MISE_E}} npm install
        npx husky
        echo "‚úì NodeJs environment ready"
    desc: 'Install NodeJs dependencies'

  deps:sync:uv:
    cmds:
      - |
        echo "üì¶ Installing Python dependencies..."
        {{.__TF_MISE_E}} uv sync
        echo "‚úì Python environment ready"
    desc: 'Install Python dependencies'

  deps:refresh:
    cmds:
      - task: deps:refresh:mise
      - task: deps:refresh:npm
    desc: 'Refresh all project dependencies'

  deps:refresh:mise:
    cmds:
      - |
        echo "üîÑ Refreshing Mise packages..."
        mise upgrade
        echo "‚úì Packages refreshed"
    desc: 'Refresh all Mise packages (update dependencies)'

  deps:refresh:npm:
    cmds:
      - |
        echo "üîÑ Refreshing NodeJs packages..."
        {{.__TF_MISE_E}} npm outdated \
          && {{.__TF_MISE_E}} npm update \
          && {{.__TF_MISE_E}} npm audit fix
        echo "‚úì Packages refreshed"
    desc: 'Refresh all NodeJs packages (update dependencies)'

  deps:refresh:uv:
    cmds:
      - |
        echo "üîÑ Refreshing Python packages..."
        {{.__TF_MISE_E}} uv sync --upgrade
        echo "‚úì Packages refreshed"
    desc: 'Refresh all Python packages (update dependencies)'
