version: "3"

vars:
  __TF_COMMAND_WRAPPER:
    sh: |
      echo '{{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command{{else}}bash -c{{end}}'
  __TF_VAR_PREFIX:
    sh: |
      echo "{{if eq OS "windows"}}\${{else}}{{end}}"
  __TF_DUMMY_SPACE: " "
  __TF_HEADER_LINE: "=============================================================="
  __TF_VALIDATION_CPP_BUILD_SYSTEMS:
    sh: |
      echo "bazel"
      # echo "bazel cmake xmake"
  __TF_VALIDATION__CPP_COMPILERS:
    sh: |
      echo "{{if eq OS "windows"}}msvc{{else}}g++{{end}} clang++"

  CPP_PROJECT_NAME: '{{default .CPP_PROJECT_NAME "cpp-template"}}'
  CPP_BUILD_SYSTEM: '{{default .CPP_BUILD_SYSTEM "bazel"}}' # bazel, cmake, xmake
  CPP_BUILD_DIR: '{{default .CPP_BUILD_DIR "build"}}'
  CPP_BUILD_TYPE: '{{default .CPP_BUILD_TYPE "Release"}}'
  CPP_COMPILER: '{{default .CPP_COMPILER "clang++"}}' # clang++, g++, msvc (windows)
  CPP_COV_TOOL: '{{default .CPP_COV_TOOL "gcovr"}}'

env:
  BAZEL_VC:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "(Get-ChildItem 'C:\Program Files*\Microsoft Visual Studio\*\*\VC\Tools\MSVC' | Sort-Object LastWriteTime -Descending | Select-Object -First 1).Parent.Parent.FullName"{{else}}echo ""{{end}}
  BAZEL_VC_FULL_VERSION:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "(Get-ChildItem 'C:\Program Files*\Microsoft Visual Studio\*\*\VC\Tools\MSVC\*' | Sort-Object LastWriteTime -Descending | Select-Object -First 1).Name"{{else}}echo ""{{end}}
  BAZEL_LLVM:
    sh: |
      {{if eq OS "windows"}}powershell -ExecutionPolicy Bypass -Command "try { (Get-Item (Get-Command clang++).Source).Directory.Parent.FullName } catch { Write-Host '' }"{{else}}echo ""{{end}}

tasks:
  # ==========================================================================
  # Build Tasks
  # ==========================================================================

  print:env:
    desc: "Print current build environment variables"
    cmds:
      - cmd: env
        platforms: [darwin, linux]
      - cmd: powershell -Command "Get-ChildItem Env:"
        platforms: [windows]

  build:
    desc: "Build project (system: {{.CPP_BUILD_SYSTEM}}, type: {{.CPP_BUILD_TYPE}})"
    cmds:
      - cmd: |
          echo "${{.__TF_HEADER_LINE}}"
          echo "Compiling for {{OS}}/{{ARCH}}, using {{.CPP_COMPILER}}"
          echo "{{.__TF_HEADER_LINE}}"
          {{if ne OS "windows"}}{{if eq .CPP_COMPILER "msvc"}}
            echo "‚ùå MSVC compiler is only supported on Windows."
            exit 1
          {{end}}{{end}}
      - task: print:env
      - task: "build:{{.CPP_BUILD_SYSTEM}}"
        vars:
          CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    sources:
      - src/**/*.cpp
      - src/**/*.hpp
      - include/**/*.hpp
      - include/**/*.h
      - tests/**/*.cpp

  build:bazel:
    desc: "Build project using Bazel"
    sources:
      - BUILD.bazel
      - tests/BUILD.bazel
      - .bazelrc
      - MODULE.bazel
      - WORKSPACE
    generates:
      - bazel-bin/{{.CPP_PROJECT_NAME}}
    env:
      CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
      CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      CPP_COMPILER: "{{.CPP_COMPILER}}"
      CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - python scripts/compile_templates.py --build-system bazel --compiler {{.CPP_COMPILER}}
      - |
        BAZEL_CONFIG="{{if eq .CPP_BUILD_TYPE "Debug"}}--compilation_mode=dbg{{else}}--compilation_mode=opt{{end}}"
        bazel build //:{{.CPP_PROJECT_NAME}} $BAZEL_CONFIG

        # Generate compile_commands.json for clang-tidy using Hedron
        {{if ne .CPP_COMPILER "msvc"}}
        bazel run @hedron_compile_commands//:refresh_all
        {{end}}

  build:cmake:
    desc: "Build project using CMake"
    sources:
      - CMakeLists.txt
      - tests/CMakeLists.txt
    generates:
      - "{{.CPP_BUILD_DIR}}/CMakeCache.txt"
      - "{{.CPP_BUILD_DIR}}/compile_commands.json"
    env:
      CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
      CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      CPP_COMPILER: "{{.CPP_COMPILER}}"
      CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - python scripts/compile_templates.py --build-system cmake --compiler {{.CPP_COMPILER}}
      - |
        CMAKE_VARS=""
        CMAKE_GENERATOR="Unix Makefiles"
        CMAKE_COMPILER_FLAG="-DCMAKE_CXX_COMPILER={{.CPP_COMPILER}}"

        # Windows-specific configuration
        {{if eq OS "windows"}}
          if [ "{{.CPP_COMPILER}}" = "msvc" ]; then
            CMAKE_GENERATOR="Visual Studio 17 2022"
            CMAKE_COMPILER_FLAG=""  # Let VS auto-detect MSVC
          else
            CMAKE_GENERATOR="Ninja"  # Better for Clang on Windows
            CMAKE_COMPILER_FLAG="-DCMAKE_CXX_COMPILER={{.CPP_COMPILER}}"
          fi
        {{end}}

        # Coverage flags (skip for MSVC)
        if [ "{{.CPP_BUILD_TYPE}}" = "Debug" ] && [ "{{.CPP_COMPILER}}" != "msvc" ]; then
            CMAKE_VARS='-DCMAKE_CXX_FLAGS="--coverage"'
        fi

        cmake -B "{{.CPP_BUILD_DIR}}" -G "$CMAKE_GENERATOR" \
            -DCMAKE_BUILD_TYPE="{{.CPP_BUILD_TYPE}}" \
            $CMAKE_COMPILER_FLAG \
            $CMAKE_VARS \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        cmake --build "{{.CPP_BUILD_DIR}}" --parallel

  build:xmake:
    desc: "Build project using XMake"
    sources:
      - xmake.lua
    generates:
      - .xmake/cache/config
      - "{{.CPP_BUILD_DIR}}/compile_commands.json"
    env:
      CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
      CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      CPP_COMPILER: "{{.CPP_COMPILER}}"
      CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - python scripts/compile_templates.py --build-system xmake --compiler {{.CPP_COMPILER}}
      - |
        XMAKE_ARGS=""
        XMAKE_TOOLCHAIN="clang"

        # Windows-specific toolchain selection
        {{if eq OS "windows"}}
          if [ "{{.CPP_COMPILER}}" = "msvc" ]; then
            XMAKE_TOOLCHAIN="msvc"
          else
            XMAKE_TOOLCHAIN="clang"
          fi
        {{end}}

        # Coverage flags (skip for MSVC)
        if [ "{{.CPP_BUILD_TYPE}}" = "Debug" ] && [ "{{.CPP_COMPILER}}" != "msvc" ]; then
            XMAKE_ARGS='--cxflags=--coverage --ldflags=--coverage'
        fi

        xmake f -m $(echo "{{.CPP_BUILD_TYPE}}" | tr '[:upper:]' '[:lower:]') \
            $XMAKE_ARGS \
            --toolchain=$XMAKE_TOOLCHAIN -y
        xmake build
        xmake project -k compile_commands "{{.CPP_BUILD_DIR}}"

  build:detect:msvc:
    desc: "Detect MSVC compiler on Windows and display configuration"
    cmds:
      - |
        {{if eq OS "windows"}}
        echo "üîç Detecting Visual Studio installation..."
        echo "VC Path: $BAZEL_VC"
        echo "VC Version: $BAZEL_VC_FULL_VERSION"
        echo "Compiler: {{.CPP_COMPILER}}"

        # Test if MSVC is accessible
        if [ "{{.CPP_COMPILER}}" = "msvc" ]; then
          powershell -Command "if (Test-Path '$env:BAZEL_VC\\bin\\Hostx64\\x64\\cl.exe') { Write-Host '‚úÖ MSVC cl.exe found' } else { Write-Host '‚ùå MSVC cl.exe not found' }"
        fi
        {{else}}
        echo "‚ÑπÔ∏è MSVC detection is only available on Windows"
        {{end}}

  # ============================================================================
  # Clean Tasks
  # ============================================================================

  clean:
    desc: "Clean all build artifacts"
    cmds:
      - |
        rm -rf \
            .bazelrc \
            .cache \
            .coverage \
            .jscpd/html \
            .task \
            .xmake \
            {{.CPP_BUILD_DIR}} \
            BUILD.bazel \
            tests/BUILD.bazel \
            CMakeLists.txt \
            MODULE.bazel \
            WORKSPACE \
            compile_commands.json \
            docs-html \
            node_modules \
            package-lock.json \
            src/CMakeLists.txt \
            xmake.lua

        find . -type d -name "bazel-*" | while read d; do rm -rf "$d"; done

  # docs:
  #   desc: "Generate documentation with Doxygen"
  #   deps:
  #     - task: which
  #       vars:
  #         COMMAND: "doxygen"
  #   cmds:
  #     - doxygen Doxyfile

  # duplicate-check:
  #   desc: "Check for duplicate code using jscpd"
  #   deps:
  #     - task: which
  #       vars:
  #         COMMAND: "node"
  #   cmds:
  #     - cmd: |
  #         [ ! -d ./node_modules ] && npm install jscpd  @jscpd/badge-reporter

  #         mise exec -- npx jscpd src/ include/

  #         git add .jscpd/jscpd-badge.svg 2>/dev/null || true

  # ============================================================================
  # Code Quality Tasks
  # ============================================================================

  format:
    desc: "Format code and fix issues"
    cmds:
      - |
        SCRIPT_ARGS="--fix"
        python scripts/format.py $SCRIPT_ARGS

  format:check:
    desc: "Check code formatting without fixing"
    cmds:
      - python scripts/format.py

  lint:
    desc: "Run linter and fix issues"
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
    cmds:
      - |
        # Bazel generates compile_commands.json at project root, others use build dir
        LINT_BUILD_DIR="{{.CPP_BUILD_DIR}}"
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            LINT_BUILD_DIR="."
        fi
        python scripts/lint.py --build-dir "$LINT_BUILD_DIR" --fix

  lint:check:
    desc: "Run linter without fixing"
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
    cmds:
      - |
        # Bazel generates compile_commands.json at project root, others use build dir
        LINT_BUILD_DIR="{{.CPP_BUILD_DIR}}"
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            LINT_BUILD_DIR="."
        fi
        python scripts/lint.py --build-dir "$LINT_BUILD_DIR"

  duplicate-check:
    desc: "Check for duplicate code using jscpd"
    cmds:
      - "[ ! -d ./node_modules ] && npm install jscpd @jscpd/badge-reporter"
      - npx jscpd src/ include/
      - git add .jscpd/jscpd-badge.svg 2>/dev/null || true

  # ============================================================================
  # Test Tasks
  # ============================================================================

  test:
    desc: "Run tests (system: {{.CPP_BUILD_SYSTEM}})"
    vars:
      TEST_BUILD_TYPE: Debug
    cmds:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_TYPE: "Debug"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
      - task: test:{{.CPP_BUILD_SYSTEM}}
        vars:
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
          CPP_COV_TOOL: "{{.CPP_COV_TOOL}}"

  test:bazel:
    desc: "Run tests with Bazel and generate coverage"
    cmds:
      - |
        if [ "{{.CPP_COMPILER}}" = "msvc" ]; then
          echo "‚úÖ Running tests without coverage for MSVC..."
          bazel test //tests/... --test_output=errors
        else
          echo "üìä Running tests with coverage for {{.CPP_COMPILER}}..."
          bazel coverage //tests/... --config=coverage
        fi
      - task: test:gen-coverage
        vars:
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COV_TOOL: "{{.CPP_COV_TOOL}}"

  test:cmake:
    desc: "Run tests with coverage using CMake"
    cmds:
      - cd {{.CPP_BUILD_DIR}} && ctest --output-on-failure
      - task: test:gen-coverage
        vars:
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COV_TOOL: "{{.CPP_COV_TOOL}}"

  test:xmake:
    desc: "Run tests with coverage using XMake"
    cmds:
      - xmake run {{.CPP_PROJECT_NAME}}-tests
      - task: test:gen-coverage
        vars:
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COV_TOOL: "{{.CPP_COV_TOOL}}"

  test:gen-coverage:
    desc: "Generate coverage report"
    cmds:
      - |
        echo ""
        echo "üìä Generating coverage report..."
        echo ""

        {{if eq .CPP_COMPILER "msvc"}}
          echo "‚ö†Ô∏è Bazel coverage is not supported with MSVC. Skipping."
          echo ""
          exit 0
        {{end}}

        # echo "üìä Running Bazel coverage..."
        # bazel coverage //tests/... --config=coverage

        # echo "üõ†Ô∏è Generating LCOV report..."
        # genhtml bazel-out/_coverage/_coverage_report.dat \
        #   --output-directory .coverage \
        #   --branch-coverage --quiet

        # echo "‚úÖ HTML report generated at: .coverage/index.html"

        # echo ""
        # case "{{.CPP_COV_TOOL}}" in
        #   gcovr)
        #     if ! command -v gcovr >/dev/null 2>&1; then
        #       echo "‚ö†Ô∏è gcovr not found. Install: uv pip install gcovr"
        #       exit 1
        #     fi
        #     mkdir -p .coverage
        #     gcovr --root . \
        #       --filter 'src/.*' --filter 'include/.*' \
        #       --exclude 'tests/.*' --exclude 'build/_deps/.*' \
        #       --gcov-ignore-errors=no_working_dir_found \
        #       --txt --html-details .coverage/index.html 2>/dev/null
        #     echo "ÔøΩ HTML report: .coverage/index.html"
        #     ;;
        #   lcov)
        #     if ! command -v lcov >/dev/null 2>&1 || ! command -v genhtml >/dev/null 2>&1; then
        #       echo "‚ö†Ô∏è lcov/genhtml not found."
        #       exit 1
        #     fi
        #     mkdir -p .coverage
        #     lcov --capture --directory "{{.CPP_BUILD_DIR}}" \
        #       --output-file .coverage/coverage.info \
        #       --rc lcov_branch_coverage=1 2>/dev/null
        #     lcov --remove .coverage/coverage.info '/usr/*' '*/tests/*' '*/build/_deps/*' \
        #       --output-file .coverage/coverage.info 2>/dev/null
        #     lcov --list .coverage/coverage.info
        #     genhtml .coverage/coverage.info \
        #       --output-directory .coverage \
        #       --branch-coverage --quiet
        #     echo "üìÑ HTML report: .coverage/index.html"
        #     ;;
        #   *)
        #     echo "‚ùå Unknown coverage tool: {{.CPP_COV_TOOL}}"
        #     exit 1
        #     ;;
        # esac
    silent: true

  # ============================================================================
  # Development Tools
  # ============================================================================

  run:
    desc: "Run application"
    deps:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
    cmds:
      - |
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            bazel run //:{{.CPP_PROJECT_NAME}}
        else
            ./{{.CPP_BUILD_DIR}}/**/{{.CPP_PROJECT_NAME}}
        fi

  debug:
    desc: "Run application with debugger (requires gdb)"
    vars:
      DEBUG_BUILD_TYPE: Debug
    cmds:
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_TYPE: "{{.DEBUG_BUILD_TYPE}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
      - |
        if ! command -v gdb >/dev/null 2>&1; then
          echo "‚ùå gdb not found. Please install gdb first."
          exit 1
        fi
        if [ "{{.CPP_BUILD_SYSTEM}}" = "bazel" ]; then
            gdb bazel-bin/{{.CPP_PROJECT_NAME}}
        else
            gdb ./{{.CPP_BUILD_DIR}}/**/{{.CPP_PROJECT_NAME}}
        fi

  # ============================================================================
  # Documentation Tasks
  # ============================================================================

  docs:
    desc: "Build documentation"
    cmds:
      - mkdocs build

  docs:serve:
    desc: "Serve documentation locally with live reload"
    cmds:
      - |
        echo "üìö Starting documentation server..."
        echo "üìñ Open http://127.0.0.1:8000 in your browser"
        mkdocs serve

  docs:deploy:
    desc: "Deploy documentation to GitHub Pages"
    cmds:
      - mkdocs gh-deploy --force

  # ============================================================================
  # Validation Tasks
  # ============================================================================

  validate:
    cmds:
      - cmd: |
          {{range $build := .__TF_VALIDATION_CPP_BUILD_SYSTEMS | splitList " "}}
            task validate:by:build-system CPP_BUILD_SYSTEM="{{$build}}"
          {{end}}
    desc: "Run integration tests for all build systems"
    silent: true

  validate:by:build-system:
    cmds:
      - cmd: |
          bs='{{.CPP_BUILD_SYSTEM}}'
          hl="{{.__TF_HEADER_LINE}}"
          {{range $compiler := .__TF_VALIDATION__CPP_COMPILERS | splitList " "}}
            echo $hl
            echo "üèÉ Running validation for $bs with {{$compiler}}..."
            echo $hl
            echo ""
            task validate:by:build-system:compiler \
              CPP_BUILD_SYSTEM="$bs" \
              CPP_COMPILER="{{$compiler}}"
          {{end}}
    desc: "Run CI pipeline for specific build system"
    silent: true

  validate:by:build-system:compiler:
    cmds:
      - task: clean
        vars:
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
      - task: build
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_TYPE: "{{.CPP_BUILD_TYPE}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
      - task: run
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
      - task: clean
      - task: test
        vars:
          CPP_BUILD_SYSTEM: "{{.CPP_BUILD_SYSTEM}}"
          CPP_BUILD_DIR: "{{.CPP_BUILD_DIR}}"
          CPP_COMPILER: "{{.CPP_COMPILER}}"
          CPP_PROJECT_NAME: "{{.CPP_PROJECT_NAME}}"
      - cmd: |
          echo ""
          echo "{{.__TF_HEADER_LINE}}"
          echo "‚úÖ Validation successful for {{.CPP_BUILD_SYSTEM}} with {{.CPP_COMPILER}}"
          echo "{{.__TF_HEADER_LINE}}"
          echo ""

  # ============================================================================
  # Python/UV Package Management Tasks
  # ============================================================================

  uv:refresh:
    desc: "Refresh all Python packages (update dependencies)"
    cmds:
      - |
        echo "üîÑ Refreshing Python packages..."
        uv sync --upgrade
        echo "‚úì Packages refreshed"

  uv:sync:
    desc: "Install Python dependencies (including pre-commit)"
    cmds:
      - |
        echo "üì¶ Installing Python dependencies..."
        uv sync
        echo "ü™ù Installing pre-commit hooks..."
        pre-commit install
        echo "‚úì Python environment ready"

  # valgrind:
  #   desc: "Run application with Valgrind"
  #   deps:
  #     - task: which
  #       vars:
  #         COMMAND: "valgrind"
  #     - task: build
  #       vars: { CPP_BUILD_TYPE: "Debug" }
  #   cmds:
  #     - mise exec -- valgrind --leak-check=full --show-leak-kinds=all ./{{.CPP_BUILD_DIR}}/src/{{.CPP_PROJECT_NAME}}
